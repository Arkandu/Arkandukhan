<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vision Drive ‚Äî Home (right-click menu, inline rename, folders, drag-drop)</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
  html,body{height:100%;background:#111;color:#fff;-webkit-font-smoothing:antialiased;margin:0}

  /* Background */
  .background{
    position:fixed;inset:0;z-index:0;
    background-image:
      url('background.png'),
      url('https://images.unsplash.com/photo-1506748686214-e9df14d4d9d0?auto=format&fit=crop&w=1920&q=80');
    background-repeat:no-repeat;background-position:center center;background-size:cover;
  }

  .app{position:relative;z-index:2;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding-bottom:160px}

  /* Topbar */
  .topbar{margin:18px;width:calc(100% - 120px);max-width:1200px;display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:rgba(255,255,255,0.06);backdrop-filter:blur(14px) saturate(160%);border-radius:14px;border:1px solid rgba(255,255,255,0.08);box-shadow:0 8px 30px rgba(0,0,0,0.35)}
  .topbar .title{font-weight:600;font-size:18px}
  .topbar .right{display:flex;gap:10px;align-items:center}
  .btn{background:rgba(255,255,255,0.08);color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer}

  /* Window (floating) */
  .window{display:none;position:absolute;top:110px;left:50%;transform:translateX(-50%);width:900px;max-width:calc(100% - 80px);max-height:calc(100% - 220px);overflow:auto;padding:18px 20px;background:rgba(255,255,255,0.08);backdrop-filter:blur(22px) saturate(160%);border-radius:16px;border:1px solid rgba(255,255,255,0.12);color:#fff;z-index:3;box-shadow:0 18px 60px rgba(0,0,0,0.45)}
  .window.dragging { opacity: 0.95; transform: none; }
  .window .h{ cursor: grab; user-select:none; display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
  .window h2{font-size:20px;margin:0}

  /* Filter bar inside windows */
  .filter-bar{display:flex;gap:12px;align-items:center;margin-bottom:12px}

  /* Home profile */
  .profile-card{display:flex;gap:18px;align-items:center;background:rgba(255,255,255,0.02);padding:14px;border-radius:12px}
  .avatar{width:100px;height:100px;border-radius:20px;overflow:hidden;flex-shrink:0;border:2px solid rgba(255,255,255,0.08)}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .profile-info{display:flex;flex-direction:column;gap:6px}
  .profile-info .name{font-size:20px;font-weight:700}
  .profile-info .meta{opacity:0.85;font-size:13px}

  /* File inputs and actions */
  input[type="file"]{width:100%;padding:8px;background:rgba(0,0,0,0.15);border-radius:8px;color:#fff}
  input, select, button, textarea{background: rgba(255,255,255,0.04); color: #fff; border:1px solid rgba(255,255,255,0.06); padding:8px; border-radius:8px}
  .window .window-actions{margin:10px 0 14px 0;display:flex;gap:12px;flex-wrap:wrap}
  .small-btn{padding:6px 10px;border-radius:8px;border:none;background:rgba(0,122,255,0.85);color:white;cursor:pointer}

  /* Documents list */
  #docList{list-style:none;padding-left:0;margin-top:14px;display:flex;flex-direction:column;gap:8px}
  .doc-item{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.03)}
  .doc-icon{width:56px;height:56px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:22px;background:rgba(0,0,0,0.2)}
  .doc-meta{flex:1;display:flex;flex-direction:column;gap:6px}
  .doc-meta .title{font-weight:600}
  .doc-meta .sub{opacity:0.85;font-size:13px}
  .doc-meta .tags{margin-top:6px;display:flex;gap:6px;flex-wrap:wrap}
  .tag{background:rgba(0,0,0,0.2);padding:4px 8px;border-radius:8px;font-size:12px;opacity:0.95}

  .doc-actions{display:flex;gap:8px}

  /* Photo gallery */
  .photo-gallery{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
  .photo-card{width:120px;height:90px;border-radius:10px;overflow:hidden;position:relative;background:rgba(255,255,255,0.02)}
  .photo-card img{width:100%;height:100%;object-fit:cover;display:block}
  .photo-overlay{position:absolute;left:0;right:0;bottom:0;padding:6px;font-size:12px;background:linear-gradient(transparent, rgba(0,0,0,0.6));color:#fff;display:flex;justify-content:space-between;align-items:center}

  /* drag-drop highlight */
  .drop-target{outline:3px dashed rgba(255,255,255,0.18);outline-offset:6px}

  /* Dock */
  .dock{position:fixed;bottom:22px;left:50%;transform:translateX(-50%);display:flex;gap:18px;padding:10px 18px;background:rgba(255,255,255,0.06);backdrop-filter:blur(20px) saturate(160%);border-radius:26px;border:1px solid rgba(255,255,255,0.12);z-index:5;box-shadow:0 12px 40px rgba(0,0,0,0.45)}
  .dock-item{font-size:28px;padding:6px;cursor:pointer;transition:transform .15s ease}
  .dock-item:hover{transform:translateY(-8px) scale(1.2)}

  /* contextual menu */
  .context-menu{position:absolute;min-width:220px;background:rgba(20,20,20,0.98);border-radius:10px;padding:8px;border:1px solid rgba(255,255,255,0.06);z-index:30;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
  .context-menu .row{display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px;cursor:pointer}
  .context-menu .row:hover{background:rgba(255,255,255,0.03)}
  .context-menu input, .context-menu select{width:100%}

  /* viewer modal */
  .viewer-modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.55);z-index:25}
  .viewer-inner{width:85%;max-width:960px;background:#fff;border-radius:12px;padding:10px}
  .viewer-close{float:right;margin-bottom:8px;padding:6px 10px;border-radius:8px;cursor:pointer}

  /* responsive */
  @media (max-width:720px){ .window{width:calc(100% - 40px);left:20px;transform:none} .photo-card{width:96px;height:72px} }
  .hidden{display:none!important}
</style>
</head>
<body>
  <div class="background" id="backgroundDiv" aria-hidden="true"></div>

  <div class="app" role="application">
    <div class="topbar" role="banner">
      <div class="title">üçè Vision Drive</div>
      <div class="right">
        <div id="userLabel">--</div>
        <button class="btn" id="logoutBtn">Logout</button>
      </div>
    </div>

    <!-- HOME -->
    <div id="home" class="window" aria-hidden="true">
      <div class="h"><h2>üè† Home ‚Äî Profile</h2><div class="drag-hint">Drag</div></div>
      <div class="profile-card">
        <div class="avatar"><img id="homeAvatar" src="https://i.pravatar.cc/200" alt="avatar"></div>
        <div class="profile-info">
          <div class="name" id="homeName">Your name</div>
          <div class="meta" id="homeUsername">username</div>
          <div class="meta" id="homeEmail">email@example.com</div>
          <div class="meta" id="homeJoined">Joined: ‚Äî</div>
          <div class="meta" id="homeFolder">Folder: Primary</div>
        </div>
        <div style="margin-left:auto;text-align:right">
          <div style="font-size:14px;opacity:0.9">Documents: <span id="homeDocs">0</span></div>
          <div style="font-size:14px;opacity:0.9">Photos: <span id="homePhotos">0</span></div>
        </div>
      </div>

      <div style="margin-top:14px">
        <h3>About</h3>
        <p id="homeAbout" style="opacity:0.9">Profile details saved from Settings appear here. Use Settings to edit display name, email and about.</p>
      </div>
    </div>

    <!-- Documents -->
    <div id="documents" class="window" aria-hidden="true">
      <div class="h"><h2>üìÇ Documents</h2><div class="drag-hint">Drag</div></div>
      <div class="filter-bar">
        <input id="docDropHint" type="file" style="display:none" multiple>
        <button class="small-btn" id="docPickBtn">Select Documents</button>
        <select id="docFilter"><option value="All">All Folders</option><option value="Primary">Primary</option><option value="Archive">Archive</option></select>
        <button class="small-btn" id="clearDocsBtn">Clear All Documents</button>
        <div style="margin-left:auto;font-size:13px;opacity:0.9">Drop files here to upload</div>
      </div>
      <ul id="docList"></ul>
    </div>

    <!-- Photos -->
    <div id="photos" class="window" aria-hidden="true">
      <div class="h"><h2>üñºÔ∏è Photos</h2><div class="drag-hint">Drag</div></div>
      <div class="filter-bar">
        <input id="photoDropHint" type="file" accept="image/*" style="display:none" multiple>
        <button class="small-btn" id="photoPickBtn">Select Photos</button>
        <select id="photoFilter"><option value="All">All Folders</option><option value="Primary">Primary</option><option value="Archive">Archive</option></select>
        <button class="small-btn" id="clearPhotosBtn">Clear All Photos</button>
        <div style="margin-left:auto;font-size:13px;opacity:0.9">Drop images here to upload</div>
      </div>
      <div id="photoGallery" class="photo-gallery"></div>
    </div>

    <!-- Settings -->
    <div id="settings" class="window" aria-hidden="true">
      <div class="h"><h2>‚öôÔ∏è Settings</h2><div class="drag-hint">Drag</div></div>
      <label>Display name</label>
      <input id="displayName" placeholder="Enter display name">
      <div style="height:8px"></div>
      <label>Email</label>
      <input id="email" placeholder="you@example.com">
      <div style="height:8px"></div>
      <label>About</label>
      <textarea id="about" placeholder="A short bio" rows="3" style="width:100%;"></textarea>
      <div style="height:12px"></div>
      <button id="saveSettings" class="small-btn">Save Settings</button>
    </div>

    <!-- Reports -->
    <div id="reports" class="window" aria-hidden="true">
      <div class="h"><h2>üìä Reports</h2><div class="drag-hint">Drag</div></div>
      <p>Total logins: <span id="reportLogins">0</span></p>
      <p>Documents uploaded: <span id="reportDocs">0</span></p>
      <p>Photos uploaded: <span id="reportPhotos">0</span></p>
      <canvas id="reportChart" width="600" height="200" style="margin-top:12px"></canvas>
    </div>

    <!-- Users (admin only) -->
    <div id="users" class="window" aria-hidden="true">
      <div class="h"><h2>üë• User Management</h2><div class="drag-hint">Drag</div></div>
      <p>(Admin only)</p>
      <ul id="userList"></ul>
    </div>

    <!-- Contextual menu (replaces modal) -->
    <div id="contextMenu" class="context-menu hidden" aria-hidden="true" role="menu">
      <!-- rows will be populated dynamically -->
    </div>

    <!-- viewer modal -->
    <div id="viewerModal" class="viewer-modal hidden" aria-hidden="true">
      <div class="viewer-inner">
        <button id="closeViewer" class="viewer-close">Close</button>
        <iframe id="viewerFrame" style="width:100%;height:70vh;border:0;background:#fff"></iframe>
      </div>
    </div>

    <!-- Dock -->
    <div class="dock" role="navigation" aria-label="Dock">
      <div class="dock-item" onclick="openWindow('home')" title="Home">üè†</div>
      <div class="dock-item" onclick="openWindow('documents')" title="Documents">üìÇ</div>
      <div class="dock-item" onclick="openWindow('photos')" title="Photos">üñºÔ∏è</div>
      <div class="dock-item" onclick="openWindow('settings')" title="Settings">‚öôÔ∏è</div>
      <div class="dock-item" onclick="openWindow('reports')" title="Reports">üìä</div>
      <div id="userMgmtDock" class="dock-item" onclick="openWindow('users')" title="User Management">üë•</div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* ---------- IndexedDB helpers ---------- */
const DB_NAME = 'visionDriveDB_v5';
const DB_VERSION = 1;
let db = null;
async function openDB(){
  return new Promise((resolve,reject)=>{
    const rq = indexedDB.open(DB_NAME,DB_VERSION);
    rq.onerror = ()=>reject(rq.error);
    rq.onupgradeneeded = ()=>{
      db = rq.result;
      if(!db.objectStoreNames.contains('photos')) db.createObjectStore('photos',{keyPath:'id',autoIncrement:true});
      if(!db.objectStoreNames.contains('docs')) db.createObjectStore('docs',{keyPath:'id',autoIncrement:true});
      if(!db.objectStoreNames.contains('users')) db.createObjectStore('users',{keyPath:'username'});
    };
    rq.onsuccess = ()=>{ db = rq.result; resolve(db); };
  });
}
function addRecord(storeName, record){ return new Promise((resolve,reject)=>{ const tx = db.transaction(storeName,'readwrite'); const store = tx.objectStore(storeName); const rq = store.add(record); rq.onsuccess = ()=>resolve(rq.result); rq.onerror = ()=>reject(rq.error); }); }
function getAllRecords(storeName){ return new Promise((resolve,reject)=>{ const tx = db.transaction(storeName,'readonly'); const store = tx.objectStore(storeName); const rq = store.getAll(); rq.onsuccess = ()=>resolve(rq.result); rq.onerror = ()=>reject(rq.error); }); }
function getRecord(storeName, key){ return new Promise((resolve,reject)=>{ const tx = db.transaction(storeName,'readonly'); const store = tx.objectStore(storeName); const rq = store.get(key); rq.onsuccess = ()=>resolve(rq.result); rq.onerror = ()=>reject(rq.error); }); }
function putRecord(storeName, record){ return new Promise((resolve,reject)=>{ const tx = db.transaction(storeName,'readwrite'); const store = tx.objectStore(storeName); const rq = store.put(record); rq.onsuccess = ()=>resolve(rq.result); rq.onerror = ()=>reject(rq.error); }); }
function deleteRecord(storeName, key){ return new Promise((resolve,reject)=>{ const tx = db.transaction(storeName,'readwrite'); const store = tx.objectStore(storeName); const rq = store.delete(key); rq.onsuccess = ()=>resolve(); rq.onerror = ()=>reject(rq.error); }); }
function clearStore(storeName){ return new Promise((resolve,reject)=>{ const tx = db.transaction(storeName,'readwrite'); const store = tx.objectStore(storeName); const rq = store.clear(); rq.onsuccess = ()=>resolve(); rq.onerror = ()=>reject(rq.error); }); }

/* utilities */
function fmtSize(bytes){ if(bytes < 1024) return bytes + ' B'; if(bytes < 1024*1024) return (bytes/1024).toFixed(1)+' KB'; return (bytes/(1024*1024)).toFixed(2)+' MB'; }
function fmtDate(ts){ const d=new Date(ts); return d.toLocaleString(); }

/* ---------- app init ---------- */
const userLabel = document.getElementById('userLabel');
const logoutBtn = document.getElementById('logoutBtn');
let loggedInUser = localStorage.getItem('loggedInUser') || null;
let isAdmin = (loggedInUser === 'arkandu.khan' || loggedInUser === 'Admin Arkandu');

if(!loggedInUser){ window.location.href = 'index.html'; } else { userLabel.innerText = loggedInUser; }
const userMgmtDock = document.getElementById('userMgmtDock'); if(!isAdmin) userMgmtDock.style.display = 'none';

/* elements */
const photoInput = document.getElementById('photoDropHint');
const docInput = document.getElementById('docDropHint');
const docList = document.getElementById('docList');
const photoGallery = document.getElementById('photoGallery');
const clearDocsBtn = document.getElementById('clearDocsBtn');
const clearPhotosBtn = document.getElementById('clearPhotosBtn');
const reportLogins = document.getElementById('reportLogins');
const reportDocs = document.getElementById('reportDocs');
const reportPhotos = document.getElementById('reportPhotos');
const viewerModal = document.getElementById('viewerModal');
const viewerFrame = document.getElementById('viewerFrame');

logoutBtn.addEventListener('click', ()=>{ localStorage.removeItem('loggedInUser'); window.location.href='index.html'; });
document.getElementById('closeViewer').addEventListener('click', ()=>{ viewerModal.classList.add('hidden'); viewerFrame.src = 'about:blank'; });

/* window behavior */
function openWindow(id){
  document.querySelectorAll('.window').forEach(w=>w.style.display='none');
  const win = document.getElementById(id); if(!win) return;
  win.style.display = 'block';
  if(id==='home') renderHome();
  if(id==='documents') renderDocs();
  if(id==='photos') renderPhotos();
  if(id==='reports') refreshReports();
  if(id==='users') renderUsers();
}

/* upload helpers */
async function storeFiles(fileList, storeName){
  for(const f of fileList){
    const record = { name:f.name, type:f.type, size:f.size, createdAt:Date.now(), blob: f, tags: [], folder: 'Primary' };
    await addRecord(storeName, record);
  }
}

/* render docs */
async function renderDocs(){
  const filter = document.getElementById('docFilter').value;
  let docs = await getAllRecords('docs');
  if(filter !== 'All') docs = docs.filter(d => (d.folder || 'Primary') === filter);
  docList.innerHTML = '';
  docs.forEach(d => {
    const li = document.createElement('li'); li.className='doc-item';
    li.dataset.id = d.id;
    // contextmenu on item (right click)
    li.addEventListener('contextmenu', (ev)=>{ ev.preventDefault(); showContextMenu(ev, 'docs', d); });

    // double-click rename via title dblclick
    const icon = document.createElement('div'); icon.className='doc-icon';
    if(d.type === 'application/pdf') icon.textContent = 'üìï';
    else if(d.type.startsWith('text')) icon.textContent = 'üìÑ';
    else if(d.type.includes('word') || d.name.endsWith('.doc')||d.name.endsWith('.docx')) icon.textContent = 'üìù';
    else icon.textContent = 'üìÅ';

    const meta = document.createElement('div'); meta.className='doc-meta';
    const title = document.createElement('div'); title.className='title'; title.textContent = d.name;
    title.title = 'Double-click to rename';
    title.addEventListener('dblclick', ()=>inlineRename('docs', d, title));

    const sub = document.createElement('div'); sub.className='sub'; sub.textContent = `${fmtSize(d.size)} ‚Ä¢ ${fmtDate(d.createdAt)} ‚Ä¢ ${d.folder || 'Primary'}`;

    const tagsWrap = document.createElement('div'); tagsWrap.className='tags';
    (d.tags || []).forEach(t => { const tg = document.createElement('span'); tg.className='tag'; tg.textContent = t; tagsWrap.appendChild(tg); });

    meta.appendChild(title); meta.appendChild(sub); meta.appendChild(tagsWrap);

    const actions = document.createElement('div'); actions.className='doc-actions';
    const viewBtn = document.createElement('button'); viewBtn.className='small-btn'; viewBtn.textContent='View';
    viewBtn.onclick = ()=>{ if(d.type === 'application/pdf' || d.type.startsWith('text') || d.type === ''){ viewerFrame.src = URL.createObjectURL(d.blob); viewerModal.classList.remove('hidden'); } else { window.open(URL.createObjectURL(d.blob), '_blank'); } };
    const dl = document.createElement('a'); dl.className='small-btn'; dl.style.textDecoration='none'; dl.href = URL.createObjectURL(d.blob); dl.download = d.name; dl.textContent = 'Download';
    const menuBtn = document.createElement('button'); menuBtn.className='small-btn'; menuBtn.textContent='‚ãØ';
    menuBtn.title = 'Open menu';
    menuBtn.onclick = (ev)=>{ ev.stopPropagation(); const rect = menuBtn.getBoundingClientRect(); showContextMenu({pageX:rect.right, pageY:rect.bottom}, 'docs', d); };

    actions.appendChild(viewBtn); actions.appendChild(dl); actions.appendChild(menuBtn);
    li.appendChild(icon); li.appendChild(meta); li.appendChild(actions);
    docList.appendChild(li);
  });
  reportDocs.innerText = (await getAllRecords('docs')).length;
  document.getElementById('homeDocs').innerText = reportDocs.innerText;
}

/* render photos */
async function renderPhotos(){
  const filter = document.getElementById('photoFilter').value;
  let photos = await getAllRecords('photos');
  if(filter !== 'All') photos = photos.filter(p => (p.folder || 'Primary') === filter);
  photoGallery.innerHTML = '';
  photos.forEach(p => {
    const card = document.createElement('div'); card.className='photo-card';
    card.dataset.id = p.id;
    card.addEventListener('contextmenu', (ev)=>{ ev.preventDefault(); showContextMenu(ev, 'photos', p); });
    const img = document.createElement('img'); img.src = URL.createObjectURL(p.blob); img.alt = p.name;
    const overlay = document.createElement('div'); overlay.className='photo-overlay';
    const left = document.createElement('div'); left.textContent = p.name;
    const right = document.createElement('div'); right.style.fontSize='11px'; right.style.opacity='0.95'; right.textContent = fmtSize(p.size);
    overlay.appendChild(left); overlay.appendChild(right);
    img.onclick = ()=>{ viewerFrame.src = img.src; viewerModal.classList.remove('hidden'); };
    overlay.addEventListener('click', (ev)=>{ ev.stopPropagation(); showContextMenu(ev, 'photos', p); });
    card.appendChild(img); card.appendChild(overlay); photoGallery.appendChild(card);
  });
  reportPhotos.innerText = (await getAllRecords('photos')).length;
  document.getElementById('homePhotos').innerText = reportPhotos.innerText;
}

/* inline rename */
async function inlineRename(storeName, record, titleEl){
  const input = document.createElement('input');
  input.value = record.name;
  input.style.width = '100%';
  titleEl.replaceWith(input);
  input.focus();
  input.select();
  function save(){
    const newName = input.value.trim() || record.name;
    const updated = Object.assign({}, record, { name:newName });
    putRecord(storeName, updated).then(()=>{ refreshAll(); });
  }
  input.addEventListener('blur', ()=>{ save(); });
  input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ input.blur(); } if(e.key==='Escape'){ refreshAll(); } });
}

/* context menu implementation (right-click near clicked item) */
const contextMenu = document.getElementById('contextMenu');
let currentContext = null;

function showContextMenu(ev, storeName, record){
  // build menu HTML dynamically
  contextMenu.innerHTML = '';
  currentContext = { storeName, record };

  // Position
  const x = ev.pageX || (ev.clientX + window.scrollX);
  const y = ev.pageY || (ev.clientY + window.scrollY);
  contextMenu.style.left = x + 'px';
  contextMenu.style.top = y + 'px';
  contextMenu.classList.remove('hidden');

  // Title row
  const titleRow = document.createElement('div'); titleRow.className='row'; titleRow.style.fontWeight='700'; titleRow.textContent = record.name;
  contextMenu.appendChild(titleRow);

  // View
  const view = document.createElement('div'); view.className='row'; view.textContent='View';
  view.onclick = ()=>{ if(storeName==='photos'){ viewerFrame.src = URL.createObjectURL(record.blob); viewerModal.classList.remove('hidden'); } else { if(record.type === 'application/pdf' || record.type.startsWith('text') || record.type === ''){ viewerFrame.src = URL.createObjectURL(record.blob); viewerModal.classList.remove('hidden'); } else { window.open(URL.createObjectURL(record.blob),'_blank'); } } closeContextMenu(); };
  contextMenu.appendChild(view);

  // Download
  const dl = document.createElement('div'); dl.className='row'; dl.textContent='Download';
  dl.onclick = ()=>{ const url = URL.createObjectURL(record.blob); const a = document.createElement('a'); a.href=url; a.download=record.name; document.body.appendChild(a); a.click(); a.remove(); closeContextMenu(); };
  contextMenu.appendChild(dl);

  // Rename (inline)
  const rename = document.createElement('div'); rename.className='row'; rename.textContent='Rename (double-click also)';
  rename.onclick = ()=>{ closeContextMenu(); // find the title element in DOM
    // use putRecord directly after prompt
    const newName = prompt('Rename to:', record.name);
    if(newName && newName.trim()){ record.name = newName.trim(); putRecord(storeName, record).then(()=>refreshAll()); }
  };
  contextMenu.appendChild(rename);

  // Tags row (editable inline)
  const tagsRow = document.createElement('div'); tagsRow.className='row';
  const tagLabel = document.createElement('span'); tagLabel.textContent='Tags: ';
  const tagInput = document.createElement('input'); tagInput.value = (record.tags||[]).join(', ');
  tagInput.style.flex='1';
  tagsRow.appendChild(tagLabel); tagsRow.appendChild(tagInput);
  contextMenu.appendChild(tagsRow);

  // Folder select
  const folderRow = document.createElement('div'); folderRow.className='row';
  const folderSelect = document.createElement('select');
  ['Primary','Archive'].forEach(f => { const o = document.createElement('option'); o.value=f; o.text=f; if((record.folder||'Primary')===f) o.selected=true; folderSelect.appendChild(o); });
  folderSelect.style.width='100%';
  folderRow.appendChild(folderSelect);
  contextMenu.appendChild(folderRow);

  // Save tags/folder button
  const saveRow = document.createElement('div'); saveRow.className='row'; saveRow.style.justifyContent='flex-end';
  const saveBtn = document.createElement('button'); saveBtn.className='small-btn'; saveBtn.textContent='Save';
  saveBtn.onclick = async ()=>{
    const tags = tagInput.value.split(',').map(s=>s.trim()).filter(s=>s);
    record.tags = tags;
    record.folder = folderSelect.value;
    await putRecord(storeName, record);
    closeContextMenu();
    await refreshAll();
  };
  saveRow.appendChild(saveBtn);
  contextMenu.appendChild(saveRow);

  // Move quick (toggle)
  const moveRow = document.createElement('div'); moveRow.className='row';
  moveRow.textContent = (record.folder==='Archive' ? 'Move to Primary' : 'Move to Archive');
  moveRow.onclick = async ()=>{ record.folder = (record.folder==='Archive' ? 'Primary':'Archive'); await putRecord(storeName, record); closeContextMenu(); await refreshAll(); };
  contextMenu.appendChild(moveRow);

  // Delete
  const delRow = document.createElement('div'); delRow.className='row'; delRow.style.color='#ff6666'; delRow.textContent='Delete';
  delRow.onclick = async ()=>{ if(confirm('Delete "'+record.name+'"?')){ await deleteRecord(storeName, record.id); closeContextMenu(); await refreshAll(); } };
  contextMenu.appendChild(delRow);

  // click outside to close
  setTimeout(()=>{ document.addEventListener('click', outsideClick); }, 0);
}

function closeContextMenu(){ contextMenu.classList.add('hidden'); contextMenu.innerHTML = ''; document.removeEventListener('click', outsideClick); currentContext=null; }
function outsideClick(e){ if(!contextMenu.contains(e.target)) closeContextMenu(); }

/* reports & chart */
async function refreshReports(){
  const logins = parseInt(localStorage.getItem('loginCount')||'1',10);
  reportLogins.innerText = logins;
  const docs = await getAllRecords('docs');
  const photos = await getAllRecords('photos');
  reportDocs.innerText = docs.length;
  reportPhotos.innerText = photos.length;
  const ctx = document.getElementById('reportChart').getContext('2d');
  if(window.usageChart) window.usageChart.destroy();
  window.usageChart = new Chart(ctx, { type:'bar', data:{ labels:['Logins','Docs','Photos'], datasets:[{label:'Counts',data:[logins,docs.length,photos.length],backgroundColor:['rgba(75,192,192,0.6)','rgba(255,205,86,0.6)','rgba(153,102,255,0.6)']}]}, options:{responsive:true,maintainAspectRatio:false} });
}

/* clear handlers */
document.getElementById('clearDocsBtn').addEventListener('click',async ()=>{ if(!confirm('Clear all documents?')) return; await clearStore('docs'); await renderDocs(); await refreshReports(); });
document.getElementById('clearPhotosBtn').addEventListener('click',async ()=>{ if(!confirm('Clear all photos?')) return; await clearStore('photos'); await renderPhotos(); await refreshReports(); });

/* pick file buttons wiring */
document.getElementById('docPickBtn').addEventListener('click', ()=> document.getElementById('docDropHint').click());
document.getElementById('photoPickBtn').addEventListener('click', ()=> document.getElementById('photoDropHint').click());
docInput.addEventListener('change', async (e)=>{ const files = Array.from(e.target.files||[]); if(files.length===0) return; await storeFiles(files,'docs'); await renderDocs(); await refreshReports(); docInput.value=''; });
photoInput.addEventListener('change', async (e)=>{ const files = Array.from(e.target.files||[]); if(files.length===0) return; await storeFiles(files,'photos'); await renderPhotos(); await refreshReports(); photoInput.value=''; });

/* filters */
document.getElementById('docFilter').addEventListener('change', ()=> renderDocs());
document.getElementById('photoFilter').addEventListener('change', ()=> renderPhotos());

/* drag-and-drop for windows */
function addDropHandlers(winEl, storeName){
  winEl.addEventListener('dragover', (e)=>{ e.preventDefault(); winEl.classList.add('drop-target'); });
  winEl.addEventListener('dragleave', ()=> winEl.classList.remove('drop-target'));
  winEl.addEventListener('drop', async (e)=>{ e.preventDefault(); winEl.classList.remove('drop-target'); const dt = e.dataTransfer; if(!dt) return; const files = Array.from(dt.files||[]); if(files.length===0) return; await storeFiles(files, storeName); await (storeName==='docs' ? renderDocs() : renderPhotos()); await refreshReports(); });
}
addDropHandlers(document.getElementById('documents'), 'docs');
addDropHandlers(document.getElementById('photos'), 'photos');

/* render users (admin) */
async function renderUsers(){ const users = await getAllRecords('users'); const userListEl = document.getElementById('userList'); userListEl.innerHTML = ''; users.forEach(u=>{ const li = document.createElement('li'); li.textContent = `${u.username} (${u.displayName||'-'}) ‚Ä¢ ${u.email||'-'}`; userListEl.appendChild(li); }); }

/* render Home profile */
async function renderHome(){
  const rec = await getRecord('users', loggedInUser);
  const displayName = (rec && rec.displayName) ? rec.displayName : loggedInUser;
  const email = (rec && rec.email) ? rec.email : '‚Äî';
  const about = (rec && rec.about) ? rec.about : '';
  const joinedTs = (rec && rec.joinedAt) ? rec.joinedAt : Date.now();
  document.getElementById('homeName').innerText = displayName;
  document.getElementById('homeUsername').innerText = `@${loggedInUser}`;
  document.getElementById('homeEmail').innerText = email;
  document.getElementById('homeJoined').innerText = 'Joined: ' + fmtDate(joinedTs);
  document.getElementById('homeAbout').innerText = about || 'Profile details saved from Settings appear here. Use Settings to edit display name, email and about.';
}

/* settings save */
document.getElementById('saveSettings').addEventListener('click', async ()=>{
  const displayName = document.getElementById('displayName').value.trim();
  const email = document.getElementById('email').value.trim();
  const about = document.getElementById('about').value.trim();
  let rec = await getRecord('users', loggedInUser) || { username: loggedInUser };
  rec.displayName = displayName || rec.displayName || loggedInUser;
  rec.email = email || rec.email || '';
  rec.about = about || rec.about || '';
  rec.joinedAt = rec.joinedAt || Date.now();
  await putRecord('users', rec);
  alert('Settings saved');
  await renderHome(); await renderUsers();
});

/* refreshAll helper */
async function refreshAll(){ await renderDocs(); await renderPhotos(); await renderUsers(); await renderHome(); await refreshReports(); }

/* make windows draggable */
function makeDraggable(win) {
  const header = win.querySelector('.h');
  let isDown=false, startX=0, startY=0, startLeft=0, startTop=0;
  header.addEventListener('mousedown', (e)=>{ isDown=true; win.classList.add('dragging'); startX=e.clientX; startY=e.clientY; const rect = win.getBoundingClientRect(); startLeft = rect.left; startTop = rect.top; win.style.left = rect.left + 'px'; win.style.top = rect.top + 'px'; win.style.transform = 'none'; });
  document.addEventListener('mousemove', (e)=>{ if(!isDown) return; const dx = e.clientX - startX; const dy = e.clientY - startY; win.style.left = (startLeft + dx) + 'px'; win.style.top = (startTop + dy) + 'px'; });
  document.addEventListener('mouseup', ()=>{ if(isDown){ isDown=false; win.classList.remove('dragging'); }});
  // touch
  header.addEventListener('touchstart', (e)=>{ const t=e.touches[0]; isDown=true; win.classList.add('dragging'); startX=t.clientX; startY=t.clientY; const rect=win.getBoundingClientRect(); startLeft=rect.left; startTop=rect.top; win.style.left=rect.left+'px'; win.style.top=rect.top+'px'; win.style.transform='none'; });
  document.addEventListener('touchmove', (e)=>{ if(!isDown) return; const t=e.touches[0]; const dx=t.clientX-startX; const dy=t.clientY-startY; win.style.left=(startLeft+dx)+'px'; win.style.top=(startTop+dy)+'px'; }, {passive:false});
  document.addEventListener('touchend', ()=>{ if(isDown){ isDown=false; win.classList.remove('dragging'); }});
}

/* initialize */
(async ()=>{
  await openDB();
  // ensure current user exists
  const tx = db.transaction('users','readwrite');
  tx.objectStore('users').put({ username: loggedInUser, displayName: loggedInUser, joinedAt: Date.now() });

  // make windows draggable
  document.querySelectorAll('.window').forEach(w=>makeDraggable(w));

  // default open home
  openWindow('home');
  document.getElementById('userLabel').innerText = loggedInUser;
  await refreshAll();
})();
</script>
</body>
</html>
